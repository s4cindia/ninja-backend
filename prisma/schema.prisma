generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String    @id @default(uuid())
  name      String
  slug      String    @unique
  settings  Json      @default("{}")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  users    User[]
  jobs     Job[]
  products Product[]
  batches  Batch[]
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  firstName String
  lastName  String
  role      UserRole  @default(USER)
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  jobs                Job[]
  feedbacks           Feedback[]
  feedbackAttachments FeedbackAttachment[] @relation("AttachmentUploader")
  acrJobs             AcrJob[]
  acrCriterionReviews AcrCriterionReview[] @relation("CriterionReviewer")
  batches             Batch[]

  @@index([tenantId])
  @@index([email])
}

enum UserRole {
  ADMIN
  USER
  VIEWER
}

model Product {
  id             String           @id @default(uuid())
  tenantId       String
  tenant         Tenant           @relation(fields: [tenantId], references: [id])
  title          String
  isbn           String?
  format         DocumentFormat
  status         ComplianceStatus @default(NOT_ASSESSED)
  lastAssessedAt DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?

  jobs  Job[]
  vpats Vpat[]

  @@index([tenantId])
  @@index([status])
}

enum DocumentFormat {
  PDF
  EPUB
}

enum ComplianceStatus {
  COMPLIANT
  NEEDS_ATTENTION
  NON_COMPLIANT
  NOT_ASSESSED
}

model Job {
  id                 String    @id @default(uuid())
  tenantId           String
  tenant             Tenant    @relation(fields: [tenantId], references: [id])
  userId             String
  user               User      @relation(fields: [userId], references: [id])
  productId          String?
  product            Product?  @relation(fields: [productId], references: [id])
  type               JobType
  status             JobStatus @default(QUEUED)
  priority           Int       @default(0)
  input              Json
  output             Json?
  error              String?
  progress           Int       @default(0)
  tokensUsed         Int       @default(0)
  costInr            Float     @default(0)
  startedAt          DateTime?
  completedAt        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  batchSourceJobIds  String[]  @default([])
  isBatchAcr         Boolean   @default(false)

  validationResults  ValidationResult[]
  artifacts          Artifact[]
  remediationChanges RemediationChange[]
  comparisonReport   ComparisonReport?

  @@index([tenantId])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([isBatchAcr])
}

model AcrVersion {
  id        String   @id @default(uuid())
  acrId     String
  version   Int
  createdAt DateTime @default(now())
  createdBy String
  changeLog Json
  snapshot  Json

  @@unique([acrId, version])
  @@index([acrId])
  @@index([createdAt])
}

enum JobType {
  PDF_ACCESSIBILITY
  EPUB_ACCESSIBILITY
  VPAT_GENERATION
  ALT_TEXT_GENERATION
  METADATA_EXTRACTION
  BATCH_VALIDATION
  ACR_WORKFLOW
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model ValidationResult {
  id        String   @id @default(uuid())
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id])
  category  String
  checkType String
  passed    Boolean
  score     Float?
  details   Json
  createdAt DateTime @default(now())

  issues Issue[]

  @@index([jobId])
  @@index([category])
}

model Issue {
  id                 String           @id @default(uuid())
  validationResultId String
  validationResult   ValidationResult @relation(fields: [validationResultId], references: [id])
  severity           IssueSeverity
  wcagCriteria       String?
  description        String
  location           String?
  suggestion         String?
  autoFixable        Boolean          @default(false)
  quickFixable       Boolean          @default(false)
  confidence         Float?           @default(0.5)
  fixType            String?
  code               String?
  filePath           String?
  status             IssueStatus      @default(PENDING)
  fixedAt            DateTime?
  fixedBy            String?
  createdAt          DateTime         @default(now())

  @@index([validationResultId])
  @@index([severity])
  @@index([confidence])
  @@index([status])
}

enum IssueStatus {
  PENDING
  FIXED
  SKIPPED
  FAILED
}

enum IssueSeverity {
  CRITICAL
  MAJOR
  MINOR
  INFO
}

model Vpat {
  id          String     @id @default(uuid())
  productId   String
  product     Product    @relation(fields: [productId], references: [id])
  version     String
  standard    String     @default("WCAG 2.1 AA")
  status      VpatStatus @default(DRAFT)
  content     Json
  generatedAt DateTime   @default(now())
  publishedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([productId])
}

enum VpatStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

model File {
  id           String      @id @default(uuid())
  tenantId     String
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  status       FileStatus  @default(UPLOADED)
  storageType  StorageType @default(LOCAL)
  storagePath  String?
  metadata     Json?
  latestJobId  String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  deletedAt    DateTime?

  artifacts Artifact[]

  @@index([tenantId])
  @@index([status])
}

enum FileStatus {
  PENDING_UPLOAD
  UPLOADED
  PROCESSING
  PROCESSED
  ERROR
}

enum StorageType {
  LOCAL
  S3
}

model GeneratedAltText {
  id          String    @id @default(uuid())
  imageId     String
  jobId       String
  shortAlt    String
  extendedAlt String?
  confidence  Float
  flags       String[]
  aiModel     String
  status      String    @default("pending")
  approvedAlt String?
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([jobId])
  @@index([imageId])
  @@index([status])
}

model LongDescription {
  id         String    @id @default(uuid())
  imageId    String
  jobId      String
  altTextId  String?
  trigger    String
  plainText  String
  markdown   String
  html       String
  wordCount  Int
  sections   Json?
  status     String    @default("pending")
  approvedBy String?
  approvedAt DateTime?
  aiModel    String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([jobId])
  @@index([imageId])
  @@index([altTextId])
}

enum FeedbackType {
  ACCESSIBILITY_ISSUE
  ALT_TEXT_QUALITY
  AUDIT_ACCURACY
  REMEDIATION_SUGGESTION
  GENERAL
  BUG_REPORT
  FEATURE_REQUEST
}

enum FeedbackStatus {
  NEW
  REVIEWED
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

model Feedback {
  id          String         @id @default(uuid())
  tenantId    String
  userId      String?
  user        User?          @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  userEmail   String?
  type        FeedbackType
  rating      Int?
  comment     String
  context     Json?
  status      FeedbackStatus @default(NEW)
  metadata    Json?
  response    String?
  respondedBy String?
  respondedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  attachments FeedbackAttachment[]

  @@index([tenantId])
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model FeedbackAttachment {
  id           String   @id @default(uuid())
  feedbackId   String
  feedback     Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  filename     String
  originalName String
  mimeType     String
  size         Int
  uploadedById String?
  uploadedBy   User?    @relation("AttachmentUploader", fields: [uploadedById], references: [id], onDelete: SetNull)
  createdAt    DateTime @default(now())

  @@index([feedbackId])
}

model Artifact {
  id        String   @id @default(cuid())
  jobId     String
  fileId    String?
  type      String
  name      String?
  data      Json
  size      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job  Job   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  file File? @relation(fields: [fileId], references: [id], onDelete: SetNull)

  @@index([jobId])
  @@index([fileId])
  @@index([jobId, type])
}

enum ChangeStatus {
  APPLIED
  REJECTED
  REVERTED
  FAILED
  SKIPPED
}

model RemediationChange {
  id            String       @id @default(uuid())
  jobId         String
  job           Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  taskId        String?
  changeNumber  Int
  issueId       String?
  ruleId        String?
  filePath      String
  elementXPath  String?
  lineNumber    Int?
  changeType    String
  description   String
  beforeContent String?      @db.Text
  afterContent  String?      @db.Text
  contextBefore String?      @db.Text
  contextAfter  String?      @db.Text
  severity      String?
  wcagCriteria  String?
  wcagLevel     String?
  status        ChangeStatus @default(APPLIED)
  appliedAt     DateTime     @default(now())
  appliedBy     String?

  @@unique([jobId, changeNumber])
  @@index([jobId])
  @@index([status])
}

model ComparisonReport {
  id            String   @id @default(uuid())
  jobId         String   @unique
  job           Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  totalChanges  Int
  appliedCount  Int
  rejectedCount Int
  skippedCount  Int
  failedCount   Int
  reportData    Json?
  pdfUrl        String?
  generatedAt   DateTime @default(now())
  generatedBy   String?

  @@index([jobId])
}

model AcrJob {
  id            String   @id @default(uuid())
  jobId         String
  tenantId      String
  userId        String
  edition       String
  status        String   @default("in_progress")
  documentTitle String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user     User                 @relation(fields: [userId], references: [id])
  criteria AcrCriterionReview[]

  @@unique([tenantId, jobId])
  @@index([jobId])
  @@index([userId])
  @@index([tenantId])
}

model AcrCriterionReview {
  id               String    @id @default(uuid())
  acrJobId         String
  criterionId      String
  criterionNumber  String
  criterionName    String
  level            String
  confidence       Int       @default(0)
  aiStatus         String
  evidence         Json?
  conformanceLevel String?
  reviewerNotes    String?   @db.Text
  reviewedAt       DateTime?
  reviewedBy       String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  acrJob   AcrJob @relation(fields: [acrJobId], references: [id], onDelete: Cascade)
  reviewer User?  @relation("CriterionReviewer", fields: [reviewedBy], references: [id])

  @@unique([acrJobId, criterionId])
  @@index([acrJobId])
}

// ============================================
// BATCH PROCESSING MODELS
// ============================================

model Batch {
  id              String      @id @default(uuid())
  tenantId        String
  userId          String
  name            String

  status          BatchStatus @default(DRAFT)

  // Progress Tracking
  totalFiles      Int         @default(0)
  filesUploaded   Int         @default(0)
  filesAudited    Int         @default(0)
  filesPlanned    Int         @default(0)
  filesRemediated Int         @default(0)
  filesFailed     Int         @default(0)

  // Summary Statistics
  totalIssuesFound    Int @default(0)
  autoFixedIssues     Int @default(0)
  quickFixIssues      Int @default(0)
  quickFixesApplied   Int @default(0)
  manualIssues        Int @default(0)
  escalatedToManual   Int @default(0)

  // ACR Generation Metadata
  acrGenerated   Boolean   @default(false)
  acrMode        String?
  acrWorkflowIds String[]
  acrGeneratedAt DateTime?

  // Relationships
  files  BatchFile[]
  tenant Tenant      @relation(fields: [tenantId], references: [id])
  user   User        @relation(fields: [userId], references: [id])

  // Timestamps
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  @@index([tenantId, status])
  @@index([userId])
  @@index([createdAt])
}

model BatchFile {
  id      String @id @default(uuid())
  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  // File Info
  fileName    String
  originalName String
  fileSize    Int
  mimeType    String @default("application/epub+zip")
  storagePath String
  storageType String @default("S3")

  // Processing Status
  status BatchFileStatus @default(UPLOADED)

  // Job References
  auditJobId String?
  planJobId  String?

  // Audit Results
  auditScore  Int?
  issuesFound Int?

  // Plan Analysis
  issuesAutoFix  Int?
  issuesQuickFix Int?
  issuesManual   Int?

  // Remediation Results
  issuesAutoFixed    Int?
  quickFixesApplied  Int      @default(0)
  remainingQuickFix  Int?
  remainingManual    Int?
  escalatedToManual  Int      @default(0)

  // File Paths
  remediatedFilePath   String?
  comparisonReportPath String?

  // Error Handling
  error        String?
  errorDetails Json?

  // Timestamps
  uploadedAt             DateTime  @default(now())
  auditStartedAt         DateTime?
  auditCompletedAt       DateTime?
  planCreatedAt          DateTime?
  remediationStartedAt   DateTime?
  remediationCompletedAt DateTime?

  @@index([batchId])
  @@index([status])
}

enum BatchStatus {
  DRAFT
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum BatchFileStatus {
  UPLOADED
  AUDITING
  AUDITED
  PLANNING
  PLANNED
  REMEDIATING
  REMEDIATED
  FAILED
  SKIPPED
}
