name: Deploy Backend to Staging

  on:
    push:
      branches:
        - main

  env:
    AWS_REGION: ap-south-1
    ECR_REPOSITORY: ninja-backend
    ECS_CLUSTER: ninja-cluster
    ECS_SERVICE: ninja-backend-task-service
    TASK_DEFINITION_FAMILY: ninja-backend-task

  jobs:
    build-and-deploy:
      name: Build and Deploy to Staging
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}

        - name: Login to Amazon ECR
          id: login-ecr
          uses: aws-actions/amazon-ecr-login@v2

        - name: Build, tag, and push image to Amazon ECR
          id: build-image
          env:
            ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            IMAGE_TAG: ${{ github.sha }}
          run: |
            docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
            docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
            echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

        - name: Download current task definition
          run: |
            aws ecs describe-task-definition \
              --task-definition ${{ env.TASK_DEFINITION_FAMILY }} \
              --query taskDefinition > task-definition.json

        - name: Inject environment variables
          run: |
            jq '(.containerDefinitions[0].environment) |= (map(select(.name != "ACE_SERVICE_URL")) + [{"name": "ACE_SERVICE_URL", "value": "${{ secrets.ACE_SERVICE_URL }}"}])' task-definition.json > task-definition-updated.json
            mv task-definition-updated.json task-definition.json

        - name: Update task definition with new image
          id: task-def
          uses: aws-actions/amazon-ecs-render-task-definition@v1
          with:
            task-definition: task-definition.json
            container-name: ninja-backend
            image: ${{ steps.build-image.outputs.image }}

        - name: Deploy to Amazon ECS
          uses: aws-actions/amazon-ecs-deploy-task-definition@v2
          with:
            task-definition: ${{ steps.task-def.outputs.task-definition }}
            service: ${{ env.ECS_SERVICE }}
            cluster: ${{ env.ECS_CLUSTER }}
            wait-for-service-stability: true

        - name: Wait for service to stabilize
          run: sleep 30

        - name: Setup Node.js for tests
          uses: actions/setup-node@v4
          with:
            node-version: "20"
            cache: npm

        - name: Install dependencies
          run: npm ci

        - name: Run integration tests against staging
          id: integration
          continue-on-error: true
          env:
            API_BASE_URL: ${{ vars.STAGING_API_URL }}
            TEST_AUTH_TOKEN: ${{ secrets.STAGING_TEST_TOKEN }}
          run: |
            echo "Running integration tests against staging..."
            npm run test:integration

        - name: Report integration test outcome
          if: always()
          run: |
            echo "Integration test outcome: ${{ steps.integration.outcome }}"
            if [ "${{ steps.integration.outcome }}" != "success" ]; then
              echo "Warning: Integration tests failed or were skipped"
            fi
