name: PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  test:
    name: Lint, Test & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npx tsc --noEmit

      - name: Run unit tests
        run: npm run test:unit

      - name: Validate migrations are idempotent
        run: |
          echo "Checking migrations for non-idempotent patterns..."
          echo "(Migrations before 20260215 are grandfathered)"
          CUTOFF_DATE="20260215"
          ERRORS=0
          for file in prisma/migrations/*/migration.sql; do
            [ -e "$file" ] || continue
            # Extract migration date from path (format: YYYYMMDDHHMMSS_name)
            dirname=$(dirname "$file")
            migration_name=$(basename "$dirname")
            migration_date=$(echo "$migration_name" | grep -oE '^[0-9]+' | cut -c1-8)
            # Skip old migrations (grandfathered) - they've already been applied
            if [[ "$migration_date" < "$CUTOFF_DATE" ]]; then
              continue
            fi
            # Check for bare ALTER TABLE without DO block
            if grep -qE "^ALTER TABLE" "$file" && ! grep -q 'DO \$\$' "$file"; then
              echo "WARNING: $file has bare ALTER TABLE without DO block"
              ERRORS=$((ERRORS + 1))
            fi
          done
          if [ $ERRORS -gt 0 ]; then
            echo "Found $ERRORS migrations that may not be idempotent"
            echo "Wrap ALTER statements in DO blocks with table existence checks"
            exit 1
          fi
          echo "All migrations look idempotent!"

      - name: Build application
        run: npm run build
