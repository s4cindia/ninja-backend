src/controllers/epub.controller.ts
Comment on lines +496 to +539
  async startRemediation(req: AuthenticatedRequest, res: Response) {
    try {
      const { jobId } = req.params;
      const tenantId = req.user?.tenantId;

      if (!tenantId) {
        return res.status(401).json({
          success: false,
          error: 'Authentication required',
        });
      }

      // Verify tenant access to the job
      const job = await prisma.job.findFirst({
        where: { id: jobId, tenantId },
      });

      if (!job) {
        return res.status(404).json({
          success: false,
          error: 'Job not found or access denied',
        });
      }

      const autoFixResults = await remediationService.autoApplyHighConfidenceFixes(jobId);

      const plan = await remediationService.getRemediationPlan(jobId);

      return res.json({
        success: true,
        data: {
          plan,
          autoFixResults,
          message: `${autoFixResults.applied} issues were automatically fixed`,
        },
      });
    } catch (error) {
      logger.error('Failed to start remediation', error instanceof Error ? error : undefined);
      return res.status(500).json({
        success: false,
        error: 'Failed to start remediation',
      });
    }
  },
@coderabbitai
coderabbitai bot
9 minutes ago
‚ö†Ô∏è Potential issue | üü† Major

üß© Analysis chain
Add change logging to the auto-remediation flow.

The autoApplyHighConfidenceFixes method in remediation.service.ts applies fixes but does not log changes via comparisonService. Without this logging, remediation changes won't appear in the Visual Comparison feature. Either integrate change logging into the existing implementation or route the endpoint to use the AutoRemediationService which already includes logging.

@avrvenkatesa	Reply...
src/controllers/epub.controller.ts
Comment on lines +2044 to +2066
              try {
                // Use updateMany with jobId to ensure we only update issues belonging to this job
                const updateResult = await prisma.issue.updateMany({
                  where: { 
                    id: task.issueId,
                    jobId: jobId  // Verify the issue belongs to this job
                  },
                  data: {
                    status: 'FIXED',
                    fixedAt: new Date(),
                    fixedBy: req.user?.email || 'system'
                  }
                });
                if (updateResult.count > 0) {
                  logger.debug(`[Batch Quick Fix] Updated issue status to FIXED: ${task.issueId}`);
                } else {
                  logger.warn(`[Batch Quick Fix] Issue not found or does not belong to job: ${task.issueId}`);
                }
              } catch (issueUpdateError) {
                // Issue may not exist, log but don't fail
                logger.warn(`[Batch Quick Fix] Could not update Issue record: ${task.issueId}: ${issueUpdateError instanceof Error ? issueUpdateError.message : String(issueUpdateError)}`);
              }
            }
@coderabbitai
coderabbitai bot
9 minutes ago
‚ö†Ô∏è Potential issue | üî¥ Critical

Fix TypeScript compilation error: jobId does not exist in Issue model.

The code attempts to filter Issues by jobId at line 2049, but according to the TypeScript error and pipeline failure, the Issue model doesn't have a jobId field. This will cause compilation to fail.