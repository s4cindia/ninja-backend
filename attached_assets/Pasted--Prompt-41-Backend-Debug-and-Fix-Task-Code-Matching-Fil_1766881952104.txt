 Prompt 41: Backend - Debug and Fix Task Code Matching

  File: src/controllers/epub.controller.ts

  Add logging to see what task codes actually exist:

  // After successful epub:type fix - Auto-complete related tasks
  let tasksAutoCompleted = 0;
  try {
    const plan = await remediationService.getRemediationPlan(jobId);

    if (plan?.tasks) {
      // DEBUG: Log all task codes to see what we're working with
      const allTaskCodes = plan.tasks.map((t: any) => ({ id: t.id, code: t.code, status: t.status }));
      console.log('All tasks in plan:', JSON.stringify(allTaskCodes, null, 2));

      // Find tasks that match epub:type issues (flexible matching)
      const relatedTasks = plan.tasks.filter((t: any) => {
        const code = (t.code || '').toUpperCase();
        const isEpubTypeIssue =
          code === 'EPUB-TYPE-HAS-MATCHING-ROLE' ||
          code.includes('EPUB-TYPE') ||
          code.includes('MATCHING-ROLE') ||
          code.includes('EPUB_TYPE') ||
          code.includes('SEM-003');

        const notCompleted = t.status !== 'completed';

        console.log(`Task ${t.id}: code="${t.code}", isEpubType=${isEpubTypeIssue}, status=${t.status}`);

        return isEpubTypeIssue && notCompleted;
      });

      console.log(`Found ${relatedTasks.length} epub:type tasks to auto-complete`);

      for (const task of relatedTasks) {
        try {
          await remediationService.updateTaskStatus(
            jobId,
            task.id,
            'completed',
            `Auto-fixed: Added ARIA roles to ${results.length} epub:type elements`,
            req.user?.email || 'system'
          );
          tasksAutoCompleted++;
          console.log(`✓ Auto-completed task: ${task.id} (${task.code})`);
        } catch (taskErr) {
          console.error(`✗ Failed to auto-complete task ${task.id}:`, taskErr);
        }
      }
    } else {
      console.log('No tasks found in remediation plan');
    }
  } catch (planErr) {
    console.error('Failed to get remediation plan:', planErr);
  }

  console.log(`Total tasks auto-completed: ${tasksAutoCompleted}`);
