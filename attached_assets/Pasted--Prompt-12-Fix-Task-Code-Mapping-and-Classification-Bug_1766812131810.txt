 Prompt 12: Fix Task Code Mapping and Classification Bugs

  Context

  Console output shows:
  By Code: { "UNKNOWN": 14 }  ← Task codes not mapped
  By Classification: Auto=0, QuickFix=0, Manual=14  ← Classification not working

  The issues have valid codes (METADATA-ACCESSMODE, EPUB-IMG-001, etc.) but they're not being carried through to tasks.

  Bug 1: Fix Task Code Extraction

  Find where tasks are created from issues. The issueCode or code field is not being mapped. Common patterns to check:

  // WRONG - missing code field
  const task = {
    title: issue.title,
    description: issue.description,
    // issueCode is missing!
  };

  // CORRECT - include the code
  const task = {
    title: issue.title,
    description: issue.description,
    issueCode: issue.code || issue.issueCode || issue.rule || 'UNKNOWN',
  };

  Search for task creation logic and ensure the issue code is properly extracted from whichever field contains it (could be code, issueCode, rule, ruleId).

  Bug 2: Fix Classification Matching

  The classification logic in fix-classification.ts needs to match the actual issue code format. Check:

  1. Are codes being compared case-sensitively when they shouldn't be?
  2. Are codes prefixed differently? (e.g., "ace-metadata-accessmode" vs "METADATA-ACCESSMODE")
  3. Is the classification function receiving the code at all, or receiving "UNKNOWN"?

  Add debug logging to classification:

  export function getFixType(issueCode: string): 'auto' | 'quickfix' | 'manual' {
    const normalizedCode = issueCode?.toUpperCase()?.trim() || '';

    console.log(`[Classification] Input: "${issueCode}" → Normalized: "${normalizedCode}"`);

    if (AUTO_FIXABLE_CODES.has(normalizedCode)) {
      console.log(`[Classification] ${normalizedCode} → AUTO`);
      return 'auto';
    }

    if (QUICK_FIXABLE_CODES.has(normalizedCode)) {
      console.log(`[Classification] ${normalizedCode} → QUICKFIX`);
      return 'quickfix';
    }

    // Check for partial matches (in case codes have prefixes)
    for (const code of QUICK_FIXABLE_CODES) {
      if (normalizedCode.includes(code) || code.includes(normalizedCode)) {
        console.log(`[Classification] ${normalizedCode} partial match ${code} → QUICKFIX`);
        return 'quickfix';
      }
    }

    console.log(`[Classification] ${normalizedCode} → MANUAL (no match)`);
    return 'manual';
  }

  Files to Check

  1. Task creation service - where issues become tasks
  2. fix-classification.ts - classification logic
  3. remediation-plan.service.ts - plan building

  Verification

  After fix, console should show:
  By Code: { "METADATA-ACCESSMODE": 1, "METADATA-ACCESSIBILITYFEATURE": 1, ... }
  By Classification: Auto=5, QuickFix=4, Manual=5

  ---
  Let me also update the todo to reflect what we actually found:

● I've updated the task list to reflect the actual bugs discovered:

  Summary of Findings:
  | Issue          | Expected             | Actual        | Status            |
  |----------------|----------------------|---------------|-------------------|
  | Deduplication  | 107 → 14             | 107 → 14      | Working correctly |
  | Task codes     | METADATA-, EPUB-     | "UNKNOWN" x14 | Bug - needs fix   |
  | Classification | Mixed Auto/QF/Manual | All Manual    | Bug - needs fix   |

  Root Cause: The task creation is not properly extracting the issue code from the source issue object. Since codes are "UNKNOWN", the classification function can't match them to the QUICK_FIXABLE_CODES set.

  Priority Fix: Focus on Bug 1 first (task code mapping). Once codes flow through correctly, classification should work automatically.

  Apply Prompt 12 to your ninja-backend repo. Look for the task creation logic - the issue code is likely in a field like rule, ruleId, or violation.rule rather than code or issueCode. The ACE checker typically uses rule for the violation code.