 Prompt for Replit Agent (ninja-backend)

  Priority 1: Critical Bug Fixes

  1. Fix isFixed logic in epub-export.service.ts (lines 355-356)

  The current logic incorrectly marks ALL issues with the same code as fixed when only one location is fixed:

  // BROKEN - marks all issues with same code as fixed
  const isFixed = completedCodes.has(code) ||
    (completedTasksByCode.has(code) && completedTasksByCode.get(code)!.has(location));

  // FIXED - only marks issues at the specific location as fixed
  const isFixed = completedTasksByCode.has(code) &&
    completedTasksByCode.get(code)!.has(location);

  2. Fix auto-remediation.service.ts (lines 171-172) - Color contrast handlers

  The auto-remediation loop calls handler(zip) but color contrast handlers need the per-issue data. Either:
  - Remove COLOR-CONTRAST from auto-remediation (since it needs specific issue data)
  - Or pass the issue data to the handler

  ---
  Priority 2: Lint Fixes

  Replace all console.log with logger.info or logger.debug:

  Files affected:
  - epub.controller.ts (lines 1281, 1347, 1348, 1353, 1357, 1358, 1362, 1387, 1393, 1405, 1415, 1475, 1506, 1511, 1512, 1520, 1526, 1532, 1536, 1543, 1548)
  - epub-modifier.service.ts (lines 1814, 1914)
  - And others listed in the lint output

  Example fix:
  // Before
  console.log('=== scanEpubTypes START ===');

  // After
  logger.info('scanEpubTypes START');

  Fix unused variables (prefix with _ or remove):

  - epub-modifier.service.ts line 312: oldContentNormalized → _oldContentNormalized or remove
  - epub-js-auditor.service.ts line 212: skipMainLandmarkCheck → _skipMainLandmarkCheck
  - contrast-validator.ts line 170: totalAnalyzed → _totalAnalyzed or remove
  - gemini.service.ts line 154: parseError → _parseError
  - response-parser.service.ts line 1: remove unused z import
  - image-extractor.service.ts line 669: err → _err, line 716: index → _index
  - structure-analyzer.service.ts line 1: remove unused PDFNumber
  - express.d.ts line 1: remove unused User import
  - file.processor.ts line 9: jobId → _jobId
  - error-handler.middleware.ts line 54: next → _next

  Fix @typescript-eslint/no-explicit-any:

  Add proper types instead of any:
  - epub.controller.ts lines 1375, 1464
  - async-handler.middleware.ts line 7
  - error-handler.middleware.ts lines 85
  - image-extractor.service.ts lines 199, 225, 407, 498
  - text-extractor.service.ts lines 240, 243, 277, 278

  ---
  Priority 3: Code Quality Improvements

  Centralize EPUB_TYPE_TO_ROLE mapping:

  Create src/config/epub-aria-mapping.ts:
  export const EPUB_TYPE_TO_ARIA_ROLE: Record<string, string> = {
    'chapter': 'doc-chapter',
    'part': 'doc-part',
    // ... complete mapping
  };

  export const SKIP_AUTO_ROLE_TYPES = new Set([
    'frontmatter', 'bodymatter', 'backmatter', 'cover'
  ]);

  Then import and use this in epub-modifier.service.ts and other files that define this mapping.
