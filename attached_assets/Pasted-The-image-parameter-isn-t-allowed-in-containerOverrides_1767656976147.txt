The image parameter isn't allowed in containerOverrides. We need to register a new task definition first.

  [BACKEND] Fix: Register task definition before running migration

  Update the migration step in .github/workflows/deploy-backend-staging.yml:

        - name: Run Prisma migrations
          env:
            ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            IMAGE_TAG: ${{ github.sha }}
          run: |
            # Download current task definition
            aws ecs describe-task-definition \
              --task-definition ${{ env.TASK_DEFINITION_FAMILY }} \
              --query taskDefinition > migration-task-def.json

            # Update image in task definition and remove incompatible fields
            jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" '
              .containerDefinitions[0].image = $IMAGE |
              del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)
            ' migration-task-def.json > migration-task-def-updated.json

            # Register new task definition with updated image
            MIGRATION_TASK_DEF_ARN=$(aws ecs register-task-definition \
              --cli-input-json file://migration-task-def-updated.json \
              --query 'taskDefinition.taskDefinitionArn' \
              --output text)

            echo "Registered migration task definition: $MIGRATION_TASK_DEF_ARN"

            # Run migration task with new image
            TASK_ARN=$(aws ecs run-task \
              --cluster ${{ env.ECS_CLUSTER }} \
              --task-definition $MIGRATION_TASK_DEF_ARN \
              --launch-type FARGATE \
              --network-configuration "awsvpcConfiguration={subnets=[${{ vars.ECS_SUBNETS }}],securityGroups=[${{ vars.ECS_SECURITY_GROUPS }}],assignPublicIp=ENABLED}" \
              --overrides '{
                "containerOverrides": [{
                  "name": "ninja-backend",
                  "command": ["npx", "prisma", "migrate", "deploy"]
                }]
              }' \
              --query 'tasks[0].taskArn' \
              --output text)

            echo "Migration task started: $TASK_ARN"

            # Wait for task to complete
            aws ecs wait tasks-stopped --cluster ${{ env.ECS_CLUSTER }} --tasks $TASK_ARN

            # Check exit code
            EXIT_CODE=$(aws ecs describe-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --tasks $TASK_ARN \
              --query 'tasks[0].containers[0].exitCode' \
              --output text)

            if [ "$EXIT_CODE" != "0" ]; then
              echo "Migration failed with exit code: $EXIT_CODE"
              exit 1
            fi

            echo "Migration completed successfully"

  Key changes:
  1. Download current task definition
  2. Update image using jq and remove incompatible fields
  3. Register new task definition with new image
  4. Run migration using the new task definition ARN