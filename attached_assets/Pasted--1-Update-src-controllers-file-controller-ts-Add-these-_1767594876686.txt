 1. Update src/controllers/file.controller.ts

  Add these imports at the top:
  import { epubAuditService } from '../services/epub/epub-audit.service';
  import { fileStorageService } from '../services/storage/file-storage.service';
  import prisma from '../lib/prisma';
  import { logger } from '../lib/logger';
  import fs from 'fs/promises';

  Add this method to the FileController class (before the closing }):

  async triggerAudit(req: Request, res: Response, next: NextFunction): Promise<void> {
    try {
      if (!req.user) {
        throw AppError.unauthorized('User not authenticated');
      }

      const file = await fileService.getFileById(req.params.id, req.user.tenantId);

      // Check if file is EPUB
      if (!file.mimeType.includes('epub') && !file.originalName.toLowerCase().endsWith('.epub')) {
        throw AppError.badRequest('Only EPUB files can be audited', ErrorCodes.FILE_UPLOAD_FAILED);
      }

      // Update file status to PROCESSING
      await fileService.updateFileStatus(file.id, req.user.tenantId, 'PROCESSING' as FileStatus);

      // Create audit job
      const job = await prisma.job.create({
        data: {
          tenantId: req.user.tenantId,
          userId: req.user.id,
          type: 'EPUB_ACCESSIBILITY',
          status: 'PROCESSING',
          input: {
            fileId: file.id,
            fileName: file.originalName,
            filePath: file.path,
          },
          startedAt: new Date(),
        },
      });

      // Run audit asynchronously
      this.runAuditAsync(file, job.id, req.user.tenantId).catch(err => {
        logger.error('Async audit failed', err);
      });

      res.status(202).json({
        success: true,
        data: {
          jobId: job.id,
          fileId: file.id,
          status: 'PROCESSING'
        },
      });
    } catch (error) {
      next(error);
    }
  }

  private async runAuditAsync(
    file: { id: string; path: string; originalName: string },
    jobId: string,
    tenantId: string
  ): Promise<void> {
    try {
      // Read file from disk
      const fileBuffer = await fs.readFile(file.path);

      // Save to job storage for later remediation
      await fileStorageService.saveFile(jobId, file.originalName, fileBuffer);

      // Run the EPUB audit
      const result = await epubAuditService.runAudit(
        fileBuffer,
        jobId,
        file.originalName
      );

      // Update job to COMPLETED
      await prisma.job.update({
        where: { id: jobId },
        data: {
          status: 'COMPLETED',
          completedAt: new Date(),
          output: JSON.parse(JSON.stringify(result)),
        },
      });

      // Update file status to PROCESSED
      await fileService.updateFileStatus(file.id, tenantId, 'PROCESSED' as FileStatus);

      logger.info(`Audit completed for file ${file.id}, job ${jobId}`);
    } catch (error) {
      logger.error('Audit failed', error instanceof Error ? error : undefined);

      // Update job to FAILED
      await prisma.job.update({
        where: { id: jobId },
        data: {
          status: 'FAILED',
          completedAt: new Date(),
          error: error instanceof Error ? error.message : 'Unknown error',
        },
      }).catch(() => {});

      // Update file status to ERROR
      await fileService.updateFileStatus(file.id, tenantId, 'ERROR' as FileStatus).catch(() => {});
    }
  }

  ---
  2. Update src/routes/files.routes.ts

  Add this route after the other routes (before export default router):

  router.post('/:id/audit', authenticate, validate(fileIdParamSchema), fileController.triggerAudit.bind(fileController));

  ---
  3. Ensure file.service.ts has updateFileStatus method

  If not already present, add to src/services/file.service.ts:

  async updateFileStatus(
    id: string,
    tenantId: string,
    status: FileStatus,
    metadata?: Record<string, unknown>
  ): Promise<File> {
    const file = await this.getFileById(id, tenantId);

    return prisma.file.update({
      where: { id: file.id },
      data: {
        status,
        ...(metadata && { metadata }),
        updatedAt: new Date(),
      },
    });
  }
