Replit Agent prompt:

  Replace the fixHeadingHierarchy method in src/services/epub/epub-modifier.service.ts with this fixed version that properly shifts headings when a document starts with h2 instead of h1:

  async fixHeadingHierarchy(zip: JSZip): Promise<ModificationResult[]> {
    const results: ModificationResult[] = [];
    const files = Object.keys(zip.files);

    for (const filePath of files) {
      if (!filePath.match(/\.(html|xhtml|htm)$/i)) continue;

      const content = await zip.file(filePath)?.async('text');
      if (!content) continue;

      const $ = cheerio.load(content, { xmlMode: true });
      let modified = false;
      const changes: string[] = [];

      const headings = $('h1, h2, h3, h4, h5, h6').toArray();
      if (headings.length === 0) continue;

      // Find the minimum heading level in the document
      const levels = headings.map(el => parseInt(el.tagName.charAt(1)));
      const minLevel = Math.min(...levels);

      // If document doesn't start with h1, shift all headings up
      if (minLevel > 1) {
        const shift = minLevel - 1;

        // Process in reverse order to avoid conflicts
        for (let i = headings.length - 1; i >= 0; i--) {
          const el = headings[i];
          const oldLevel = parseInt(el.tagName.charAt(1));
          const newLevel = Math.max(1, oldLevel - shift);

          if (oldLevel !== newLevel) {
            const $el = $(el);
            const headingContent = $el.html();
            const attrs = el.attribs || {};
            const attrString = Object.entries(attrs)
              .map(([k, v]) => `${k}="${v}"`)
              .join(' ');

            $el.replaceWith(`<h${newLevel}${attrString ? ' ' + attrString : ''}>${headingContent}</h${newLevel}>`);
            changes.push(`h${oldLevel} → h${newLevel}`);
            modified = true;
          }
        }
      }

      if (modified) {
        zip.file(filePath, $.html());
        results.push({
          success: true,
          filePath,
          modificationType: 'fix_heading_hierarchy',
          description: `Fixed heading hierarchy: shifted ${changes.length} heading(s)`,
          after: changes.join(', '),
        });
      }
    }

    if (results.length === 0) {
      results.push({
        success: true,
        filePath: 'all',
        modificationType: 'fix_heading_hierarchy',
        description: 'Heading hierarchy is correct',
      });
    }

    return results;
  }

  The fix: Instead of only fixing skipped levels, this now detects if the minimum heading level is > 1 and shifts ALL headings up by that amount. For example, if a document starts with h2, all headings get shifted: h2→h1, h3→h2, etc.
