 Fix the CodeRabbit security review issues on PR #33. Here are the required changes:

  Critical Fixes (Security)

  1. src/routes/acr.routes.ts - Add authorization middleware

  Add authorizeJob middleware to the /analysis/:jobId route:
  import { authorizeJob } from '../middleware/authorize-job.middleware';

  // Line 10 - Change from:
  router.get('/analysis/:jobId', acrController.getAnalysis.bind(acrController));

  // To:
  router.get('/analysis/:jobId', authorizeJob, acrController.getAnalysis.bind(acrController));

  2. src/utils/authorization.ts - Remove unsafe optional function

  Delete authorizeJobAccessOptional entirely - it allows bypassing authorization when userId is undefined. Only keep authorizeJobAccess which always requires userId.

  3. src/services/acr/acr-analysis.service.ts - Make userId required

  Change getAnalysisForJob signature to require userId:
  // Line 172 - Change from:
  export async function getAnalysisForJob(jobId: string, userId?: string): Promise<AcrAnalysis>

  // To:
  export async function getAnalysisForJob(jobId: string, userId: string): Promise<AcrAnalysis>
  Then update the where clause to always include userId:
  const job = await prisma.job.findFirst({
    where: {
      id: jobId,
      userId: userId
    },
  });

  4. src/controllers/acr.controller.ts - Pass userId from request

  Update the controller to pass req.user.id to the service:
  const analysis = await acrAnalysisService.getAnalysisForJob(jobId, req.user!.id);

  Major Fixes

  5. Error handling - Return 404 for "not found"

  In the acr controller, catch the "Job not found" error and return 404:
  } catch (error) {
    if (error instanceof Error && error.message.includes('not found')) {
      return res.status(404).json({
        success: false,
        error: { message: 'Job not found or access denied' }
      });
    }
    next(error);
  }

  After making these changes, run npm run build to ensure no TypeScript errors.

  ---