 Two issues found:

  1. Duplicate role attribute - Adding role to elements that already have one
  2. Malformed nav - Still getting corrupted

  The regex patterns need fixing. Also, we added role="navigation" to nav, but the epub:type fix already added it!

  ---
  Prompt 53: Backend - Fix addAriaLandmarks to Avoid Duplicates

  async addAriaLandmarks(zip: JSZip): Promise<ModificationResult[]> {
    const results: ModificationResult[] = [];
    const files = Object.keys(zip.files);

    for (const filePath of files) {
      if (!filePath.match(/\.(html|xhtml|htm)$/i)) continue;

      let content = await zip.file(filePath)?.async('text');
      if (!content) continue;

      let modified = false;

      // Check if main landmark already exists
      const hasMainRole = /role\s*=\s*["']main["']/i.test(content);
      const hasMainElement = /<main[\s>]/i.test(content);

      if (!hasMainRole && !hasMainElement) {
        // Find first <section that doesn't already have a role attribute
        // More precise pattern: match <section with attributes, ensure no role= exists
        const match = content.match(/<section([^>]*)>/i);

        if (match) {
          const fullTag = match[0];
          const attributes = match[1];

          // Only add if no role attribute exists in this tag
          if (!/\brole\s*=/i.test(attributes)) {
            const newTag = fullTag.replace(/<section/i, '<section role="main"');
            content = content.replace(fullTag, newTag);
            modified = true;
            results.push({
              success: true,
              filePath,
              modificationType: 'add_landmark',
              description: 'Added role="main" to first section element',
            });
          }
        }
      }

      // DON'T add role="navigation" to nav - epub:type fix already handles this
      // DON'T add role="banner" or role="contentinfo" - can cause conflicts

      if (modified) {
        zip.file(filePath, content);
        console.log(`addAriaLandmarks modified: ${filePath}`);
      }
    }

    return results;
  }

  ---
  Key changes:
  1. Only adds role="main" to first section (if no main exists)
  2. Removed nav/header/footer handling - these conflict with epub:type fixes
  3. Better duplicate checking using \brole\s*= pattern