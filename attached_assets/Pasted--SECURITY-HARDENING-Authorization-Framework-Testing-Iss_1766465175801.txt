# SECURITY HARDENING: Authorization Framework & Testing

## Issue Description
Prevent future authorization vulnerabilities through systematic security measures.

## Implementation Tasks

### 1. Create Authorization Helper
Create src/utils/authorization.ts:
```typescript
export const authorizeJobAccess = async (jobId: string, userId: string) => {
  const job = await prisma.job.findFirst({
    where: { 
      id: jobId,
      userId: userId 
    },
  });
  
  if (!job) {
    throw new Error('Job not found or access denied');
  }
  
  return job;
};
```

### 2. Authorization Middleware
Create src/middleware/authorize-job.middleware.ts:
```typescript
export const authorizeJob = async (req: Request, res: Response, next: NextFunction) => {
  try {
    const jobId = req.params.jobId;
    const userId = req.user?.id;
    
    if (!userId || !jobId) {
      return res.status(401).json({ error: 'Unauthorized' });
    }
    
    const job = await authorizeJobAccess(jobId, userId);
    req.job = job; // Attach to request
    next();
  } catch (error) {
    return res.status(404).json({ error: 'Resource not found or access denied' });
  }
};
```

### 3. Apply to Routes
Update routes to use authorization:
```typescript
// Before
router.get('/audit/:jobId/result', authenticate, epubController.getAuditResult);

// After  
router.get('/audit/:jobId/result', authenticate, authorizeJob, epubController.getAuditResult);
```

### 4. Security Test Suite
Create tests/security/authorization.test.ts:
```typescript
describe('Authorization Tests', () => {
  test('User cannot access other user job results', async () => {
    // Test cross-user access is blocked
  });
  
  test('Valid user can access own job results', async () => {
    // Test legitimate access works
  });
  
  test('Unauthenticated access is blocked', async () => {
    // Test authentication requirement
  });
});
```

## Code Review Checklist
Add to team code review process:
- [ ] All job queries include userId scoping
- [ ] Error messages don't leak information
- [ ] Authorization middleware applied to protected routes
- [ ] Security tests cover authorization scenarios

## Files to Create/Update
- src/utils/authorization.ts (new)
- src/middleware/authorize-job.middleware.ts (new)  
- src/routes/epub.routes.ts (update)
- tests/security/authorization.test.ts (new)

Implement systematic authorization framework to prevent future vulnerabilities.