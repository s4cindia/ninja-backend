# OnlyOffice Document Server - Production Configuration
#
# This configuration is designed for AWS ECS deployment
# with proper security settings and SSL termination via ALB/CloudFront.
#
# Deployment Options:
#   1. ECS Fargate with this task definition
#   2. EC2 with Docker Compose
#   3. EKS with Kubernetes manifests
#
# Security:
#   - JWT authentication enabled (REQUIRED)
#   - SSL termination at load balancer level
#   - Health checks configured
#
# Environment Variables (set in ECS task definition or .env.prod):
#   - ONLYOFFICE_JWT_SECRET: Strong random string (32+ chars)
#   - ONLYOFFICE_SECURE_LINK_SECRET: Strong random string
#   - API_URL: Backend API URL for callbacks
#   - AWS_REGION: AWS region for CloudWatch logs (default: ap-south-1)

services:
  onlyoffice-documentserver:
    image: onlyoffice/documentserver:8.0
    container_name: ninja-onlyoffice-prod
    restart: always
    ports:
      - "80:80"
    environment:
      # JWT Configuration (REQUIRED - compose will fail if not set)
      - JWT_ENABLED=true
      - JWT_SECRET=${ONLYOFFICE_JWT_SECRET:?ONLYOFFICE_JWT_SECRET must be set}
      - JWT_HEADER=Authorization
      - JWT_IN_BODY=true

      # Security (REQUIRED - compose will fail if not set)
      - SECURE_LINK_SECRET=${ONLYOFFICE_SECURE_LINK_SECRET:?ONLYOFFICE_SECURE_LINK_SECRET must be set}
      # Note: ALLOW_PRIVATE_IP_ADDRESS and ALLOW_META_IP_ADDRESS are intentionally
      # not set in production to prevent SSRF attacks via internal IP ranges

      # Performance (adjust based on expected load)
      - DS_LOG_LEVEL=WARNING
      - WOPI_ENABLED=false

      # File conversion limits (MB)
      - FILE_CONVERTER_TIMEOUT=300
      - FILE_CONVERTER_MAX_DOWNLOAD_SIZE=100

      # Session/editing limits
      - EDITING_SESSION_TIMEOUT=60
      - EDITING_SESSION_ABSOLUTE_TIMEOUT=240
      - MAX_CONNECTIONS=20

    volumes:
      - onlyoffice_data:/var/www/onlyoffice/Data
      - onlyoffice_log:/var/log/onlyoffice

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

    logging:
      driver: "awslogs"
      options:
        awslogs-group: "/ecs/ninja-onlyoffice"
        awslogs-region: "${AWS_REGION:-ap-south-1}"
        awslogs-stream-prefix: "onlyoffice"

    networks:
      - ninja-prod-network

volumes:
  onlyoffice_data:
    driver: local
  onlyoffice_log:
    driver: local

networks:
  ninja-prod-network:
    driver: bridge
